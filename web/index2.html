<html>

<head>
    <title>Tic-tak-toe</title>
    <script>
        const EventTypeInit = 1
        const EventTypeConnect = 2
        const EventTypeGameStarted = 3
        const EventTypeYouTurn = 4
        const EventTypeNotYouTurn = 5
        const EventTypeStep = 6
        const EventTypeFieldUpdate = 7
        const EventTypeGameEnded = 8
        const EventTypeGameFailed = 9

        let playerMark = undefined;
        let conn;

        document.addEventListener("DOMContentLoaded", ready);

        function ready() {
            document.querySelectorAll('.game-cell').forEach(item => {
                item.addEventListener('click', clickHandler)
            })

            if (window["WebSocket"]) {
                conn = new WebSocket("ws://" + document.location.host + "/ws");
                conn.onclose = function (evt) {
                    console.log('Connection closed.');
                };
                conn.onmessage = function (evt) {
                    //var messages = evt.data.split('\n');
                    let e = JSON.parse(evt.data);
                    handleEvent(e);
                };
            } else {
                var item = document.createElement("div");
                item.innerHTML = "<b>Your browser does not support WebSockets.</b>";
                appendLog(item);
            }
        }

        function handleEvent(e) {
            let turnNotificationCell = document.getElementById('turnNotification');
            let gameResult = document.getElementById('gameResult');

            switch (e.Type) {
                case EventTypeInit:
                    playerMark = e.Data.Label;
                    console.log('You mark is ' + playerMark);
                    document.title = 'Player Mark is ' + playerMark;

                    let playerMarkCell = document.getElementById('playerMark');
                    playerMarkCell.innerHTML = playerMark;
                    break;
                case EventTypeGameStarted:
                    if (e.Data.IsFirstPlayer) {
                        console.log('You are first');
                    } else {
                        console.log('You are second');
                    }
                    break;
                case EventTypeYouTurn:
                    turnNotificationCell.innerHTML = 'You turn';
                    break;
                case EventTypeNotYouTurn:
                    turnNotificationCell.innerHTML = 'Oponent turn';
                    break;
                case EventTypeFieldUpdate:
                    let field = e.Data.Field;
                    for (let i = 0; i < field.length; i++) {
                        for (let j = 0; j < field[i].length; j++) {
                            let id = `cell_${i}_${j}`;
                            let cell = document.getElementById(id);
                            cell.innerHTML = field[i][j];
                            // console.log(field[i][j]);
                        }
                    }
                    // console.log(e.Data);
                    break;
                case EventTypeGameEnded:
                    if (e.Data.IsWin) {
                        document.title = 'Congrats! You are winner!';
                    } else {
                        document.title = 'My sorry! You are lose!';
                    }

                    gameResult.innerHTML = document.title;
                    break
                case EventTypeGameFailed:
                    document.title = 'No winners! Reconnect to attempt one more time ;)';
                    gameResult.innerHTML = document.title;
                    // alert('No winners! Reconnect to attempt one more time ;)')
                    break
            }
        }

        const clickHandler = function (event) {
            let cell = event.currentTarget;

            let rowId = cell.getAttribute('data-row-id');
            let collId = cell.getAttribute('data-coll-id');

            let click = {
                "Type": EventTypeStep,
                "Data": {
                    "Row": parseInt(rowId),
                    "Coll": parseInt(collId),
                }
            }

            conn.send(JSON.stringify(click));
        }


    </script>

    <style>
        .winCondition {
            background-color: cadetblue;
        }

        .divField {
            margin: auto;
            width: 500px;
            height: 500px;
        }

        .gameField {
            border: 1px dashed;
            width: 100%;
            height: 100%;
            text-align: center;
        }

        .game-cell {
            font-size: 5rem;
        }
    </style>

</head>
<body>

<div class="divField">
    <table class="gameField">
        <tr>
            <td class="game-cell" id="cell_0_0" data-row-id="0" data-coll-id="0">_</td>
            <td class="game-cell" id="cell_0_1" data-row-id="0" data-coll-id="1">_</td>
            <td class="game-cell" id="cell_0_2" data-row-id="0" data-coll-id="2">_</td>
        </tr>
        <tr>
            <td class="game-cell" id="cell_1_0" data-row-id="1" data-coll-id="0">_</td>
            <td class="game-cell" id="cell_1_1" data-row-id="1" data-coll-id="1">_</td>
            <td class="game-cell" id="cell_1_2" data-row-id="1" data-coll-id="2">_</td>
        </tr>
        <tr>
            <td class="game-cell" id="cell_2_0" data-row-id="2" data-coll-id="0">_</td>
            <td class="game-cell" id="cell_2_1" data-row-id="2" data-coll-id="1">_</td>
            <td class="game-cell" id="cell_2_2" data-row-id="2" data-coll-id="2">_</td>
        </tr>
    </table>

    <table>
        <tr>
            <td>You figure</td>
            <td id="playerMark"></td>
        </tr>
        <tr>
            <td>Whose turn</td>
            <td id="turnNotification"></td>
        </tr>
    </table>
    <h3 id="gameResult"></h3>
</div>

<form id="formOneMoreTime" style="display: none;">
    <input type="submit" value="One more time">
</form>

</body>
</html>
