<html>

<head>
    <title>Tic-tak-toe</title>
    <script>
        const TypeInit = 1
        const TypeConnect = 2
        const TypeGameStarted = 3
        const TypeYouTurn = 4
        const TypeNotYouTurn = 5
        const TypeStep = 6
        const TypeFieldUpdate = 7
        const TypeGameEnded = 8
        const TypeGameFailed = 9

        let playerMark = undefined;
        let conn;

        document.addEventListener("DOMContentLoaded", ready);

        function ready() {
            document.querySelectorAll('.game-cell').forEach(item => {
                item.addEventListener('click', clickHandler)
            })

            if (window["WebSocket"]) {
                conn = new WebSocket("ws://" + document.location.host + "/ws");
                conn.onclose = function (evt) {
                    console.log('Connection closed.');
                };
                conn.onmessage = function (evt) {
                    //var messages = evt.data.split('\n');
                    let e = JSON.parse(evt.data);
                    handleEvent(e);
                };
            } else {
                var item = document.createElement("div");
                item.innerHTML = "<b>Your browser does not support WebSockets.</b>";
                appendLog(item);
            }
        }

        function handleEvent(e) {
            let turnNotificationCell = document.getElementById('turnNotification');
            let gameResult = document.getElementById('gameResult');

            switch (e.type) {
                case TypeInit:
                    playerMark = e.data.Label;
                    // console.log('You mark is ' + playerMark);
                    document.title = 'GameID ' + e.data.GameID;

                    let playerMarkCell = document.getElementById('playerMark');
                    playerMarkCell.innerHTML = 'You mark is ' + playerMark;
                    break;
                case TypeGameStarted:
                    if (e.data.IsFirstPlayer) {
                        console.log('You are first');
                    } else {
                        console.log('You are second');
                    }
                    break;
                case TypeYouTurn:
                    turnNotificationCell.innerHTML = 'You turn';
                    turnNotificationCell.classList.remove('opponentStep');
                    turnNotificationCell.classList.add('youStep');
                    break;
                case TypeNotYouTurn:
                    turnNotificationCell.innerHTML = 'Oponent turn';
                    turnNotificationCell.classList.remove('youStep');
                    turnNotificationCell.classList.add('opponentStep');
                    break;
                case TypeFieldUpdate:
                    let field = e.data.Field;
                    for (let i = 0; i < field.length; i++) {
                        for (let j = 0; j < field[i].length; j++) {
                            let id = `cell_${i}_${j}`;
                            let cell = document.getElementById(id);
                            cell.innerHTML = field[i][j];
                            // console.log(field[i][j]);
                        }
                    }
                    // console.log(e.data);
                    break;
                case TypeGameEnded:
                    if (e.data.IsWin) {
                        document.title = 'Congrats! You are winner!';
                    } else {
                        document.title = 'My sorry! You are lose!';
                    }

                    e.data.Condition.forEach(point => {
                        let id = `cell_${point[0]}_${point[1]}`;
                        let cell = document.getElementById(id);
                        cell.classList.add('winCondition');
                    });

                    gameResult.innerHTML = document.title;
                    turnNotificationCell.innerHTML = '';
                    break
                case TypeGameFailed:
                    document.title = 'No winners! Reconnect to attempt one more time ;)';
                    gameResult.innerHTML = document.title;
                    turnNotificationCell.innerHTML = '';
                    // alert('No winners! Reconnect to attempt one more time ;)')
                    break
            }
        }

        const clickHandler = function (event) {
            let cell = event.currentTarget;

            let rowId = cell.getAttribute('data-row-id');
            let collId = cell.getAttribute('data-coll-id');

            let click = {
                "type": TypeStep,
                "data": {
                    "Row": parseInt(rowId),
                    "Coll": parseInt(collId),
                }
            }

            conn.send(JSON.stringify(click));
        }


    </script>

    <style>
        .winCondition {
            background-color: cadetblue;
        }

        .youStep {
            color: darkgreen;
        }

        .opponentStep {
            color: indianred;
        }

        .divField {
            margin: auto;
            width: 500px;
            height: 500px;
        }

        .gameField {
            border: 1px dashed;
            width: 100%;
            height: 100%;
            text-align: center;
        }

        .game-cell {
            font-size: 5rem;
            min-width: 182px;
        }

        .centeredText {
            text-align: center;
        }
    </style>

</head>
<body>

<div class="divField">
    <table class="gameField">
        <tr>
            <td class="game-cell" id="cell_0_0" data-row-id="0" data-coll-id="0">_</td>
            <td class="game-cell" id="cell_0_1" data-row-id="0" data-coll-id="1">_</td>
            <td class="game-cell" id="cell_0_2" data-row-id="0" data-coll-id="2">_</td>
        </tr>
        <tr>
            <td class="game-cell" id="cell_1_0" data-row-id="1" data-coll-id="0">_</td>
            <td class="game-cell" id="cell_1_1" data-row-id="1" data-coll-id="1">_</td>
            <td class="game-cell" id="cell_1_2" data-row-id="1" data-coll-id="2">_</td>
        </tr>
        <tr>
            <td class="game-cell" id="cell_2_0" data-row-id="2" data-coll-id="0">_</td>
            <td class="game-cell" id="cell_2_1" data-row-id="2" data-coll-id="1">_</td>
            <td class="game-cell" id="cell_2_2" data-row-id="2" data-coll-id="2">_</td>
        </tr>
    </table>

    <h3 class="centeredText" id="playerMark"></h3>
    <h3 class="centeredText" id="turnNotification"></h3>
    <h2 class="centeredText" id="gameResult"></h2>
</div>

<form id="formOneMoreTime" style="display: none;">
    <input type="submit" value="One more time">
</form>

</body>
</html>
